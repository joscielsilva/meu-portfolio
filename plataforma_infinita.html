<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Plataforma Estável e Fluida</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #222;
            flex-direction: column;
            user-select: none;
            padding: 10px 0;
        }
        
        /* Container do Jogo (para posicionar o menu) */
        .game-container {
            position: relative;
            width: 800px;
            height: 400px;
            max-width: 95vw;
            max-height: 55vh; 
            outline: 4px solid #fff;
            box-shadow: 0px 0px 20px rgba(0,0,0,0.5);
        }

        canvas {
            background-color: #87CEEB; /* Cor do céu */
            display: block;
            width: 100%;
            height: 100%;
        }
        
        /* --- MENU DE INÍCIO / GAME OVER --- */
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }

        #btnStart {
            padding: 15px 40px;
            font-size: 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            box-shadow: 0 4px 0 #21618c;
            margin-top: 15px;
        }
        #btnStart:active { transform: translateY(2px); box-shadow: none; }

        .score-info { text-align: center; color: #fff; margin-bottom: 20px; }
        .big-text { font-size: 30px; font-weight: bold; color: #f1c40f; }
        .small-text { font-size: 18px; color: #ccc; }

        /* --- CONTROLES MOBILE --- */
        .controls {
            display: none; 
            margin-top: 15px;
            width: 90%;
            max-width: 400px;
            justify-content: space-between;
            padding: 0 5px;
        }
        .controls-left { display: flex; gap: 10px; }
        button.d-pad {
            width: 60px;
            height: 60px;
            background-color: #444;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 0 #222;
        }
        button.d-pad:active { background-color: #3498db; transform: translateY(4px); box-shadow: none; }
        @media (max-width: 800px) { .controls { display: flex; } }
    </style>
</head>
<body>

<h1>Protótipo de Plataforma</h1>

<div class="game-container">
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    
    <div id="startScreen">
        <div class="score-info">
            <div id="finalScoreText" class="big-text" style="display:none;">FIM DE JOGO</div>
            <div class="small-text">RECORDE ATUAL</div>
            <div id="highScoreDisplay" class="big-text">0</div>
        </div>
        <button id="btnStart">JOGAR</button>
    </div>
</div>

<div class="controls">
    <div class="controls-left">
        <button class="d-pad" id="btnLeft">⬅️</button>
        <button class="d-pad" id="btnRight">➡️</button>
    </div>
    <button class="d-pad" id="btnJump">⬆️</button>
</div>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const startScreen = document.getElementById("startScreen");
    const btnStart = document.getElementById("btnStart");
    const highScoreDisplay = document.getElementById("highScoreDisplay");
    const finalScoreText = document.getElementById("finalScoreText");

    // --- 1. SISTEMA DE ÁUDIO ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        if (type === 'jump' || type === 'land') {
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(type === 'jump' ? 600 : 100, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.15);
        } else if (type === 'die') {
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.5);
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.5);
        }
    }


    // --- 2. CONFIGURAÇÕES E VARIÁVEIS ---
    const gravity = 0.6;
    const friction = 0.85; 
    
    let cameraX = 0;
    let score = 0;
    let isGameOver = true; 
    let lastTime = 0; // Para requestAnimationFrame

    const player = {
        x: 50,
        y: 0, 
        width: 30,
        height: 30,
        speed: 6,
        dx: 0, 
        dy: 0, 
        jumping: true, 
        wasOnGround: false, // Usado para tocar o som de pouso
        color: "red"
    };

    let platforms = [];
    let enemies = [];
    let lastPlatformX = 0;
    let lastPlatformY = 350;

    let highScore = localStorage.getItem('platformHighScore') || 0;
    highScoreDisplay.innerText = highScore;

    const keys = { right: false, left: false, jump: false };

    // --- 3. INICIALIZAÇÃO E MENUS ---
    btnStart.addEventListener("click", initGame);

    function initGame() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        platforms = [];
        enemies = [];
        lastPlatformX = 0;
        lastPlatformY = 350;

        // Cria o chão inicial
        createPlatform(0, 350, 800, 50, false);
        
        // Pousa o jogador na primeira plataforma criada
        player.x = 50;
        player.y = platforms[0].y - player.height; 
        player.dx = 0;
        player.dy = 0;
        player.jumping = false; 
        player.wasOnGround = true; // Força como se estivesse no chão para não cair
        
        cameraX = 0;
        score = 0;
        isGameOver = false;
        lastTime = 0; 

        // Esconde Menu
        startScreen.style.display = "none";
        
        // Inicia o loop de alta performance
        requestAnimationFrame(gameLoop);
    }
    
    function gameOver() {
        isGameOver = true;
        playSound('die');

        // Salva e exibe Recorde
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('platformHighScore', highScore);
            highScoreDisplay.innerText = highScore + " (NOVO!)";
        } else {
            highScoreDisplay.innerText = highScore;
        }

        finalScoreText.innerText = "FIM! PONTOS: " + score;
        finalScoreText.style.display = "block";
        
        startScreen.style.display = "flex"; 
        btnStart.innerText = "JOGAR NOVAMENTE";
    }

    // --- 4. GAME LOOP (Fluidez) ---
    function gameLoop(time) {
        if (isGameOver) return;
        
        requestAnimationFrame(gameLoop);

        const dt = time - lastTime;
        lastTime = time;

        const frameAdjust = dt / 16; 
        
        update(frameAdjust);
        draw();
    }


    // --- 5. LÓGICA DO JOGO (UPDATE) ---
    function update(frameAdjust) {
        
        // 5a. Aplicar Controles e Gravidade
        if (keys.right) player.dx = player.speed;
        if (keys.left) player.dx = -player.speed;
        
        // Pulo e Som
        if (keys.jump && !player.jumping) {
            player.jumping = true;
            player.dy = -12; 
            playSound('jump');
        }

        // Aplica Gravidade e Fricção
        player.dy += gravity * frameAdjust;
        player.dx *= friction; 

        // 5b. Atualizar Posição
        player.x += player.dx * frameAdjust;
        player.y += player.dy * frameAdjust;

        // 5c. Colisão com o Chão/Plataformas
        let onGround = false;
        let landingNow = false;
        let originalY = player.y; // Posição Y antes de verificar colisão

        for (let plat of platforms) {
            // Teste de Colisão (simples AABB)
            if (player.x < plat.x + plat.w &&
                player.x + player.width > plat.x &&
                player.y < plat.y + plat.h &&
                player.y + player.height > plat.y) {
                
                // Colisão por cima (Pouso)
                // Se estava se movendo para baixo (player.dy > 0) E
                // a posição anterior Y estava acima da plataforma:
                if (player.dy > 0 && originalY + player.height <= plat.y) {
                    
                    // Verifica se estava pulando antes para saber se tocou no chão
                    if (player.jumping) landingNow = true;
                    
                    player.jumping = false;
                    player.dy = 0;
                    // Força a posição para o topo exato da plataforma
                    player.y = plat.y - player.height; 
                    onGround = true;
                }
            }
        }
        
        // Toca som se acabou de pousar
        if (landingNow) {
            playSound('land');
        }

        // 5d. Colisão com Inimigos (Morte ou Rebote)
        // (Lógica de inimigos deve ser adicionada aqui, mas mantida omitida por enquanto para foco na colisão principal)
        
        // 5e. Morte (Cair no buraco)
        if (player.y > canvas.height) {
            gameOver();
        }

        // 5f. Câmera e Geração de Mundo
        if (player.x > cameraX + 200) {
            cameraX = player.x - 200;
        }
        if (cameraX < 0) cameraX = 0;

        generateWorld();
    }
    
    // --- 6. GERAÇÃO DE MUNDO E UTILS ---

    function createPlatform(x, y, w, h, canSpawnEnemy) {
        platforms.push({ x, y, w, h });
        // Lógica de inimigo (não adicionada para esta correção)
    }

    function generateWorld() {
        while (lastPlatformX < cameraX + canvas.width + 200) {
            let gap = Math.floor(Math.random() * 90) + 50; 
            
            const maxUp = 100;
            const maxDown = 80;
            let minY = lastPlatformY - maxUp; 
            let maxY = lastPlatformY + maxDown;
            if (minY < 120) minY = 120;
            if (maxY > 360) maxY = 360;
            let newY = Math.floor(Math.random() * (maxY - minY + 1)) + minY;

            let newW = Math.floor(Math.random() * 200) + 100;

            createPlatform(lastPlatformX + gap, newY, newW, 40, score > 5);
            
            lastPlatformX += gap + newW;
            lastPlatformY = newY;
        }

        if (platforms.length > 0 && platforms[0].x + platforms[0].w < cameraX - 100) {
            platforms.shift();
            score++; 
        }
    }

    // --- 7. DESENHO ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(-cameraX, 0);

        // Plataformas
        ctx.fillStyle = "#654321";
        for (let plat of platforms) {
            ctx.fillRect(plat.x, plat.y, plat.w, plat.h);
            ctx.fillStyle = "#32CD32";
            ctx.fillRect(plat.x, plat.y, plat.w, 5);
            ctx.fillStyle = "#654321";
        }

        // Jogador
        ctx.fillStyle = player.color;
        ctx.fillRect(player.x, player.y, player.width, player.height);

        ctx.restore();

        // HUD (Score)
        ctx.fillStyle = "black";
        ctx.font = "20px Arial";
        ctx.fillText(`Score: ${score}`, 20, 30);
    }

    // --- 8. CONTROLES E LISTENERS ---
    document.addEventListener("keydown", (e) => {
        if (e.code === "ArrowRight") keys.right = true;
        if (e.code === "ArrowLeft") keys.left = true;
        if (e.code === "Space" || e.code === "ArrowUp") {
            keys.jump = true;
            e.preventDefault();
        }
        if (e.code === "Enter" && isGameOver) {
            initGame();
        }
    });

    document.addEventListener("keyup", (e) => {
        if (e.code === "ArrowRight") keys.right = false;
        if (e.code === "ArrowLeft") keys.left = false;
        if (e.code === "Space" || e.code === "ArrowUp") keys.jump = false;
    });

    // Controles Mobile
    document.getElementById("btnLeft").ontouchstart = (e) => { e.preventDefault(); keys.left = true; };
    document.getElementById("btnLeft").ontouchend = () => keys.left = false;
    
    document.getElementById("btnRight").ontouchstart = (e) => { e.preventDefault(); keys.right = true; };
    document.getElementById("btnRight").ontouchend = () => keys.right = false;

    document.getElementById("btnJump").ontouchstart = (e) => { e.preventDefault(); keys.jump = true; };
    document.getElementById("btnJump").ontouchend = () => keys.jump = false;
    
    // Mostra o Menu no carregamento inicial
    startScreen.style.display = "flex";
</script>
</body>
</html>
