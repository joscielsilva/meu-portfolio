<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Plataforma - Mais Inimigos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #222;
            flex-direction: column;
            user-select: none;
            padding: 10px 0;
            font-family: Arial, sans-serif;
        }
        
        .game-container {
            position: relative;
            width: 800px;
            height: 400px;
            max-width: 95vw;
            max-height: 55vh; 
            outline: 4px solid #fff;
            box-shadow: 0px 0px 20px rgba(0,0,0,0.5);
            overflow: hidden; 
            background-color: #87CEEB; 
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated; 
        }
        
        /* MENU */
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            color: white;
        }

        #btnStart {
            padding: 15px 40px;
            font-size: 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            box-shadow: 0 4px 0 #21618c;
            margin-top: 20px;
            transition: transform 0.1s;
        }
        #btnStart:active { transform: translateY(2px); box-shadow: none; }

        .big-text { font-size: 32px; font-weight: bold; color: #f1c40f; margin-bottom: 10px; text-shadow: 2px 2px #000; }
        .small-text { font-size: 18px; color: #ccc; }

        /* HUD */
        .score-info { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            color: black; 
            font-weight: bold;
            z-index: 10;
            font-size: 18px;
            text-shadow: 1px 1px #fff;
        }

        /* CONTROLES MOBILE */
        .controls {
            display: none; 
            margin-top: 15px;
            width: 90%;
            max-width: 400px;
            justify-content: space-between;
            padding: 0 5px;
        }
        .controls-left { display: flex; gap: 10px; }
        button.d-pad {
            width: 60px;
            height: 60px;
            background-color: #444;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 0 #222;
        }
        button.d-pad:active { background-color: #3498db; transform: translateY(4px); box-shadow: none; }
        @media (max-width: 800px) { .controls { display: flex; } }
    </style>
</head>
<body>

<h1>Super Plataforma</h1>

<div class="game-container">
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    
    <div class="score-info">
        Score: <span id="currentScore">0</span><br>
        Recorde: <span id="highScoreDisplay">0</span>
    </div>

    <div id="startScreen">
        <div id="menuTitle" class="big-text">SUPER PLATAFORMA</div>
        <div class="small-text">Recorde Atual: <span id="menuHighScore">0</span></div>
        <div id="finalScoreText" style="display:none; color: #ff6b6b; margin-top:10px; font-weight:bold;"></div>
        <button id="btnStart">INICIAR</button>
    </div>

</div>

<div class="controls">
    <div class="controls-left">
        <button class="d-pad" id="btnLeft">⬅️</button>
        <button class="d-pad" id="btnRight">➡️</button>
    </div>
    <button class="d-pad" id="btnJump">⬆️</button>
</div>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    
    const startScreen = document.getElementById("startScreen");
    const btnStart = document.getElementById("btnStart");
    const menuTitle = document.getElementById("menuTitle");
    const menuHighScore = document.getElementById("menuHighScore");
    const finalScoreText = document.getElementById("finalScoreText");
    const currentScoreDisplay = document.getElementById("currentScore");
    const highScoreDisplay = document.getElementById("highScoreDisplay");
    
    // --- 1. ÁUDIO ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        if (type === 'jump' || type === 'land') {
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(type === 'jump' ? 600 : 100, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.15);
        } else if (type === 'die') {
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.5);
        } else if (type === 'kill') {
            oscillator.type = 'triangle';
            oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
        }
    }

    // --- 2. CONFIGURAÇÕES ---
    const gravity = 0.6;
    const friction = 0.60; 
    const jumpForce = -13; 
    
    let cameraX = 0;
    let score = 0;
    let isGameOver = true; 
    let lastTime = 0; 
    let animationFrameId = null;

    const player = {
        x: 50,
        y: 0, 
        width: 32,
        height: 32,
        speed: 6,
        dx: 0, 
        dy: 0, 
        jumping: false, 
        facing: 'right' 
    };

    let platforms = [];
    let enemies = []; 
    let lastPlatformX = 0;
    let lastPlatformY = 350;

    let highScore = localStorage.getItem('platformHighScore') || 0;
    highScoreDisplay.innerText = highScore;
    menuHighScore.innerText = highScore;

    const keys = { right: false, left: false };

    // --- 3. INICIALIZAÇÃO ---
    btnStart.addEventListener("click", () => { initGame(); });

    function initGame() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        platforms = [];
        enemies = [];
        lastPlatformX = 0;
        lastPlatformY = 350;
        cameraX = 0;
        score = 0;
        lastTime = 0; 

        createPlatform(0, 350, 800, 50, false);
        
        player.x = 50;
        player.y = platforms[0].y - player.height; 
        player.dx = 0;
        player.dy = 0;
        player.jumping = false; 
        player.facing = 'right'; 
        
        currentScoreDisplay.innerText = score;
        
        startScreen.style.display = "none";
        isGameOver = false;

        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        animationFrameId = requestAnimationFrame(gameLoop);
    }
    
    function showGameOver() {
        isGameOver = true;
        playSound('die');

        if (score > highScore) {
            highScore = score;
            localStorage.setItem('platformHighScore', highScore);
            highScoreDisplay.innerText = highScore;
            menuHighScore.innerText = highScore + " (NOVO!)";
        } else {
            menuHighScore.innerText = highScore;
        }

        menuTitle.innerText = "GAME OVER";
        finalScoreText.innerText = "Sua Pontuação: " + score;
        finalScoreText.style.display = "block";
        btnStart.innerText = "TENTAR NOVAMENTE";
        
        startScreen.style.display = "flex";
    }

    // --- 4. GAME LOOP ---
    function gameLoop(time) {
        if (isGameOver) return;
        
        animationFrameId = requestAnimationFrame(gameLoop);

        const dt = time - lastTime;
        lastTime = time;

        const frameAdjust = Math.min(dt / 16, 2); 
        
        update(frameAdjust);
        draw();
    }

    // --- 5. UPDATE ---
    function update(frameAdjust) {
        
        // Controles Laterais
        if (keys.right) {
            player.dx = player.speed;
            player.facing = 'right'; 
        }
        if (keys.left) {
            player.dx = -player.speed;
            player.facing = 'left'; 
        }
        
        let wasJumping = player.jumping; 

        // Gravidade e Fricção
        player.dy += gravity * frameAdjust;
        player.dx *= friction; 

        player.x += player.dx * frameAdjust;
        player.y += player.dy * frameAdjust;

        // --- COLISÃO COM PLATAFORMAS ---
        let onGround = false;
        for (let plat of platforms) {
            if (player.x < plat.x + plat.w &&
                player.x + player.width > plat.x &&
                player.y < plat.y + plat.h &&
                player.y + player.height > plat.y) {
                
                if (player.dy >= 0) { 
                    player.y = plat.y - player.height; 
                    if (wasJumping) playSound('land');
                    player.jumping = false;
                    player.dy = 0;
                    onGround = true;
                }
                else if (player.dy < 0) {
                    player.dy = 0;
                    player.y = plat.y + plat.h; 
                }
            }
        }
        
        if (!onGround) {
            player.jumping = true; 
        }

        // --- ATUALIZAÇÃO DE INIMIGOS E COLISÃO ---
        for (let i = enemies.length - 1; i >= 0; i--) {
            let enemy = enemies[i];
            
            enemy.x += enemy.speed * frameAdjust;

            if (enemy.x <= enemy.minX || enemy.x + enemy.width >= enemy.maxX) {
                enemy.speed *= -1;
            }

            // Colisão Player vs Inimigo
            if (player.x < enemy.x + enemy.width - 5 &&
                player.x + player.width > enemy.x + 5 &&
                player.y < enemy.y + enemy.height &&
                player.y + player.height > enemy.y) {
                
                // Matar inimigo
                if (player.dy > 0 && player.y + player.height < enemy.y + enemy.height / 2 + 10) {
                    enemies.splice(i, 1); 
                    player.dy = -7; 
                    playSound('kill');
                    score += 5; 
                    currentScoreDisplay.innerText = score;
                } else {
                    // Game Over
                    showGameOver();
                    return;
                }
            }
        }

        // Morte por queda
        if (player.y > canvas.height) {
            showGameOver();
            return;
        }

        // Câmera
        if (player.x > cameraX + 200) {
            cameraX = player.x - 200;
        }
        if (cameraX < 0) cameraX = 0;

        generateWorld();
    }
    
    // --- 6. GERAÇÃO DE MUNDO (MAIS INIMIGOS) ---
    function createPlatform(x, y, w, h, canSpawnEnemy) {
        h = Math.ceil(h / 20) * 20;
        platforms.push({ x, y, w, h });

        // AUMENTADO: Spawnar Inimigo
        // 50% de chance se a plataforma for > 80px
        if (canSpawnEnemy && w > 80 && Math.random() < 0.5) {
            enemies.push({
                x: x + 40,
                y: y - 32, // Altura do inimigo
                width: 32,
                height: 32,
                speed: 2, 
                minX: x,
                maxX: x + w,
                color: "#8e44ad" // Roxo
            });
        }
    }

    function generateWorld() {
        while (lastPlatformX < cameraX + canvas.width + 200) {
            let gap = Math.floor(Math.random() * 90) + 60; 
            
            const maxUp = 100;
            const maxDown = 80;
            let minY = lastPlatformY - maxUp; 
            let maxY = lastPlatformY + maxDown;
            if (minY < 150) minY = 150;
            if (maxY > 360) maxY = 360;
            let newY = Math.floor(Math.random() * (maxY - minY + 1)) + minY;
            newY = Math.floor(newY / 20) * 20; 

            let newW = Math.floor(Math.random() * 200) + 120;

            // score > 0 : inimigos aparecem logo após a primeira plataforma
            createPlatform(lastPlatformX + gap, newY, newW, 40, score > 0);
            
            lastPlatformX += gap + newW;
            lastPlatformY = newY;
        }

        if (platforms.length > 0 && platforms[0].x + platforms[0].w < cameraX - 100) {
            platforms.shift();
            score++; 
            currentScoreDisplay.innerText = score;
        }
        if (enemies.length > 0 && enemies[0].maxX < cameraX - 100) {
            enemies.shift();
        }
    }

    // --- 7. DESENHO ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(-cameraX, 0);

        // --- PLATAFORMAS ---
        const blockSize = 20; 
        const grassHeight = 10; 

        for (let plat of platforms) {
            ctx.fillStyle = "#4CAF50"; 
            ctx.fillRect(plat.x, plat.y, plat.w, grassHeight);
            ctx.fillStyle = "#2E7D32";
            ctx.fillRect(plat.x, plat.y + grassHeight - 2, plat.w, 2);

            ctx.strokeStyle = "#5D4037"; 
            ctx.lineWidth = 2;

            for (let by = plat.y + grassHeight; by < plat.y + plat.h; by += blockSize) {
                for (let bx = plat.x; bx < plat.x + plat.w; bx += blockSize) {
                    let currentBlockWidth = Math.min(blockSize, plat.x + plat.w - bx);
                    let currentBlockHeight = Math.min(blockSize, plat.y + plat.h - by);

                    ctx.fillStyle = "#8B4513"; 
                    ctx.fillRect(bx, by, currentBlockWidth, currentBlockHeight);
                    ctx.strokeRect(bx, by, currentBlockWidth, currentBlockHeight);

                    ctx.fillStyle = "#5D4037"; 
                    if (currentBlockWidth > 8 && currentBlockHeight > 8) ctx.fillRect(bx + 6, by + 6, 4, 4);
                    if (currentBlockWidth > 15 && currentBlockHeight > 15) ctx.fillRect(bx + 14, by + 14, 3, 3);
                }
            }
        }

        // --- INIMIGOS ---
        for (let enemy of enemies) {
            ctx.fillStyle = enemy.color;
            ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
            
            ctx.fillStyle = "white";
            ctx.fillRect(enemy.x + 4, enemy.y + 6, 8, 8);
            ctx.fillRect(enemy.x + 20, enemy.y + 6, 8, 8);
            
            ctx.fillStyle = "red"; 
            ctx.fillRect(enemy.x + 6, enemy.y + 8, 4, 4);
            ctx.fillRect(enemy.x + 22, enemy.y + 8, 4, 4);
            
            ctx.fillStyle = "black";
            ctx.fillRect(enemy.x + 8, enemy.y + 22, 16, 4);
        }

        // --- ROBÔ (PLAYER) ---
        ctx.save();
        ctx.translate(player.x + player.width / 2, player.y + player.height / 2);
        
        if (player.facing === 'left') {
            ctx.scale(-1, 1); 
        }

        ctx.fillStyle = "#e74c3c";
        ctx.fillRect(-12, -10, 24, 26);
        ctx.fillStyle = "#ecf0f1";
        ctx.fillRect(-10, -26, 20, 16);
        ctx.fillStyle = "#3498db";
        ctx.fillRect(2, -22, 10, 6);
        ctx.fillStyle = "#95a5a6";
        ctx.fillRect(-16, -8, 4, 16);
        ctx.fillStyle = "#95a5a6";
        let walkOffset = 0;
        if (!player.jumping && Math.abs(player.dx) > 0.5) {
            walkOffset = Math.sin(Date.now() / 80) * 4; 
        }
        ctx.fillRect(-10 + walkOffset, 16, 6, 4);
        ctx.fillRect(4 - walkOffset, 16, 6, 4);

        ctx.restore(); 
        ctx.restore(); 
    }

    // --- 8. EVENTOS ---
    
    document.addEventListener("keydown", (e) => {
        if (e.repeat) return; 

        if (e.code === "ArrowRight") keys.right = true;
        if (e.code === "ArrowLeft") keys.left = true;
        
        if (e.code === "Space" || e.code === "ArrowUp") {
            if (!player.jumping) {
                player.jumping = true;
                player.dy = jumpForce; 
                playSound('jump');
            }
            e.preventDefault();
        }
        if (e.code === "Enter" && isGameOver) initGame();
    });

    document.addEventListener("keyup", (e) => {
        if (e.code === "ArrowRight") keys.right = false;
        if (e.code === "ArrowLeft") keys.left = false;
        
        // Pulo Curto (Corte)
        if (e.code === "Space" || e.code === "ArrowUp") {
            if (player.dy < -3) {
                player.dy = -3; 
            }
        }
    });

    // Mobile
    const jumpBtn = document.getElementById("btnJump");
    
    document.getElementById("btnLeft").ontouchstart = (e) => { e.preventDefault(); keys.left = true; };
    document.getElementById("btnLeft").ontouchend = () => keys.left = false;
    document.getElementById("btnRight").ontouchstart = (e) => { e.preventDefault(); keys.right = true; };
    document.getElementById("btnRight").ontouchend = () => keys.right = false;

    jumpBtn.ontouchstart = (e) => { 
        e.preventDefault(); 
        if (!player.jumping) {
            player.jumping = true;
            player.dy = jumpForce;
            playSound('jump');
        }
    };
    
    jumpBtn.ontouchend = (e) => {
        if (player.dy < -3) {
            player.dy = -3;
        }
    };
    
    createPlatform(0, 350, 800, 60);
    draw();

</script>
</body>
</html>
