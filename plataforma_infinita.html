<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Plataforma com Personagem</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #222;
            flex-direction: column;
            user-select: none;
            padding: 10px 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .game-container {
            position: relative;
            width: 800px;
            height: 400px;
            max-width: 95vw;
            max-height: 55vh; 
            outline: 4px solid #fff;
            box-shadow: 0px 0px 20px rgba(0,0,0,0.5);
            overflow: hidden;
            background-color: #87CEEB; /* Céu */
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        /* MENU */
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            color: white;
        }

        #btnStart {
            padding: 15px 40px;
            font-size: 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            box-shadow: 0 4px 0 #21618c;
            margin-top: 20px;
            transition: transform 0.1s;
        }
        #btnStart:active { transform: translateY(2px); box-shadow: none; }

        .big-text { font-size: 32px; font-weight: bold; color: #f1c40f; margin-bottom: 10px; text-shadow: 2px 2px #000; }
        .small-text { font-size: 18px; color: #fff; text-shadow: 1px 1px #000; }

        /* HUD */
        .score-info { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            color: black; 
            font-weight: bold;
            z-index: 10;
            font-size: 18px;
            background: rgba(255,255,255,0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }

        /* CONTROLES MOBILE */
        .controls {
            display: none; 
            margin-top: 15px;
            width: 90%;
            max-width: 400px;
            justify-content: space-between;
            padding: 0 5px;
        }
        .controls-left { display: flex; gap: 10px; }
        button.d-pad {
            width: 60px;
            height: 60px;
            background-color: #444;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 0 #222;
        }
        button.d-pad:active { background-color: #3498db; transform: translateY(4px); box-shadow: none; }
        @media (max-width: 800px) { .controls { display: flex; } }
    </style>
</head>
<body>

<h1>Super Plataforma</h1>

<div class="game-container">
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    
    <div class="score-info">
        Score: <span id="currentScore">0</span><br>
        Recorde: <span id="highScoreDisplay">0</span>
    </div>

    <div id="startScreen">
        <div id="menuTitle" class="big-text">SUPER PLATAFORMA</div>
        <div class="small-text">Recorde Atual: <span id="menuHighScore">0</span></div>
        <div id="finalScoreText" style="display:none; color: #ff6b6b; margin-top:10px; font-weight:bold;"></div>
        <button id="btnStart">INICIAR</button>
    </div>
</div>

<div class="controls">
    <div class="controls-left">
        <button class="d-pad" id="btnLeft">⬅️</button>
        <button class="d-pad" id="btnRight">➡️</button>
    </div>
    <button class="d-pad" id="btnJump">⬆️</button>
</div>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    
    // Elementos DOM
    const startScreen = document.getElementById("startScreen");
    const btnStart = document.getElementById("btnStart");
    const menuTitle = document.getElementById("menuTitle");
    const menuHighScore = document.getElementById("menuHighScore");
    const finalScoreText = document.getElementById("finalScoreText");
    const currentScoreDisplay = document.getElementById("currentScore");
    const highScoreDisplay = document.getElementById("highScoreDisplay");
    
    // --- 1. ÁUDIO ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        if (type === 'jump' || type === 'land') {
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(type === 'jump' ? 600 : 100, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.15);
        } else if (type === 'die') {
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.5);
        }
    }

    // --- 2. VARIAVEIS ---
    const gravity = 0.6;
    const friction = 0.85; 
    
    let cameraX = 0;
    let score = 0;
    let isGameOver = true; 
    let lastTime = 0; 
    let animationFrameId = null;

    const player = {
        x: 50,
        y: 0, 
        width: 32,
        height: 32,
        speed: 6,
        dx: 0, 
        dy: 0, 
        jumping: false, 
        facing: 'right' 
    };

    let platforms = [];
    let lastPlatformX = 0;
    let lastPlatformY = 350;

    let highScore = localStorage.getItem('platformHighScore') || 0;
    highScoreDisplay.innerText = highScore;
    menuHighScore.innerText = highScore;

    const keys = { right: false, left: false, jump: false };

    // --- 3. INICIALIZAÇÃO ---
    btnStart.addEventListener("click", () => { initGame(); });

    function initGame() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        platforms = [];
        lastPlatformX = 0;
        lastPlatformY = 350;
        cameraX = 0;
        score = 0;
        lastTime = 0; 

        // Chão inicial
        createPlatform(0, 350, 800, 50);
        
        // Posição
        player.x = 50;
        player.y = platforms[0].y - player.height; 
        player.dx = 0;
        player.dy = 0;
        player.jumping = false; 
        player.facing = 'right'; 
        
        currentScoreDisplay.innerText = score;
        
        startScreen.style.display = "none";
        isGameOver = false;

        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        animationFrameId = requestAnimationFrame(gameLoop);
    }
    
    function showGameOver() {
        isGameOver = true;
        playSound('die');

        if (score > highScore) {
            highScore = score;
            localStorage.setItem('platformHighScore', highScore);
            highScoreDisplay.innerText = highScore;
            menuHighScore.innerText = highScore + " (NOVO!)";
        } else {
            menuHighScore.innerText = highScore;
        }

        menuTitle.innerText = "GAME OVER";
        finalScoreText.innerText = "Sua Pontuação: " + score;
        finalScoreText.style.display = "block";
        btnStart.innerText = "TENTAR NOVAMENTE";
        
        startScreen.style.display = "flex";
    }

    // --- 4. GAME LOOP ---
    function gameLoop(time) {
        if (isGameOver) return;
        
        animationFrameId = requestAnimationFrame(gameLoop);

        const dt = time - lastTime;
        lastTime = time;

        const frameAdjust = Math.min(dt / 16, 2); 
        
        update(frameAdjust);
        draw();
    }

    // --- 5. UPDATE ---
    function update(frameAdjust) {
        
        if (keys.right) {
            player.dx = player.speed;
            player.facing = 'right'; 
        }
        if (keys.left) {
            player.dx = -player.speed;
            player.facing = 'left'; 
        }
        
        let wasJumping = player.jumping; 

        if (keys.jump && !player.jumping) {
            player.jumping = true;
            player.dy = -12; 
            playSound('jump');
        }

        player.dy += gravity * frameAdjust;
        player.dx *= friction; 

        player.x += player.dx * frameAdjust;
        player.y += player.dy * frameAdjust;

        let onGround = false;
        for (let plat of platforms) {
            if (player.x < plat.x + plat.w &&
                player.x + player.width > plat.x &&
                player.y < plat.y + plat.h &&
                player.y + player.height > plat.y) {
                
                if (player.dy >= 0) { 
                    player.y = plat.y - player.height; 
                    if (wasJumping) playSound('land');
                    player.jumping = false;
                    player.dy = 0;
                    onGround = true;
                }
                else if (player.dy < 0) {
                    player.dy = 0;
                    player.y = plat.y + plat.h; 
                }
            }
        }
        
        if (!onGround) player.jumping = true; 

        if (player.y > canvas.height) {
            showGameOver();
            return;
        }

        if (player.x > cameraX + 200) {
            cameraX = player.x - 200;
        }
        if (cameraX < 0) cameraX = 0;

        generateWorld();
    }
    
    // --- 6. MUNDO ---
    function createPlatform(x, y, w, h) {
        platforms.push({ x, y, w, h });
    }

    function generateWorld() {
        while (lastPlatformX < cameraX + canvas.width + 200) {
            let gap = Math.floor(Math.random() * 90) + 50; 
            
            const maxUp = 100;
            const maxDown = 80;
            let minY = lastPlatformY - maxUp; 
            let maxY = lastPlatformY + maxDown;
            if (minY < 120) minY = 120;
            if (maxY > 360) maxY = 360;
            let newY = Math.floor(Math.random() * (maxY - minY + 1)) + minY;

            let newW = Math.floor(Math.random() * 200) + 100;

            createPlatform(lastPlatformX + gap, newY, newW, 40);
            
            lastPlatformX += gap + newW;
            lastPlatformY = newY;
        }

        if (platforms.length > 0 && platforms[0].x + platforms[0].w < cameraX - 100) {
            platforms.shift();
            score++; 
            currentScoreDisplay.innerText = score;
        }
    }

    // --- 7. DESENHO (DRAW) ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(-cameraX, 0);

        // Plataformas
        ctx.fillStyle = "#5D4037"; // Terra
        for (let plat of platforms) {
            ctx.fillRect(plat.x, plat.y, plat.w, plat.h);
            ctx.fillStyle = "#4CAF50"; // Grama
            ctx.fillRect(plat.x, plat.y, plat.w, 8); 
            ctx.fillStyle = "#5D4037";
        }

        // --- DESENHO DO PERSONAGEM (Código, não imagem) ---
        // Aqui desenhamos o robô usando quadrados para ele nunca sumir
        ctx.save();
        
        // Vai para o centro do jogador
        ctx.translate(player.x + player.width / 2, player.y + player.height / 2);
        
        // Vira o personagem se estiver olhando para esquerda
        if (player.facing === 'left') {
            ctx.scale(-1, 1); 
        }

        // 1. Corpo
        ctx.fillStyle = "#e74c3c"; // Vermelho
        ctx.fillRect(-12, -10, 24, 26);

        // 2. Cabeça
        ctx.fillStyle = "#ecf0f1"; // Branco
        ctx.fillRect(-10, -26, 20, 16);

        // 3. Olhos (Visor)
        ctx.fillStyle = "#3498db"; // Azul
        ctx.fillRect(2, -22, 10, 6);

        // 4. Mochila a Jato (Jetpack)
        ctx.fillStyle = "#95a5a6"; // Cinza
        ctx.fillRect(-16, -8, 4, 16);

        ctx.restore(); // Restaura virada
        ctx.restore(); // Restaura câmera
    }

    // --- 8. EVENTOS ---
    document.addEventListener("keydown", (e) => {
        if (e.code === "ArrowRight") keys.right = true;
        if (e.code === "ArrowLeft") keys.left = true;
        if (e.code === "Space" || e.code === "ArrowUp") {
            keys.jump = true;
            e.preventDefault();
        }
        if (e.code === "Enter" && isGameOver) initGame();
    });

    document.addEventListener("keyup", (e) => {
        if (e.code === "ArrowRight") keys.right = false;
        if (e.code === "ArrowLeft") keys.left = false;
        if (e.code === "Space" || e.code === "ArrowUp") keys.jump = false;
    });

    document.getElementById("btnLeft").ontouchstart = (e) => { e.preventDefault(); keys.left = true; };
    document.getElementById("btnLeft").ontouchend = () => keys.left = false;
    document.getElementById("btnRight").ontouchstart = (e) => { e.preventDefault(); keys.right = true; };
    document.getElementById("btnRight").ontouchend = () => keys.right = false;
    document.getElementById("btnJump").ontouchstart = (e) => { e.preventDefault(); keys.jump = true; };
    document.getElementById("btnJump").ontouchend = () => keys.jump = false;

    // Desenha a tela inicial (fundo)
    createPlatform(0, 350, 800, 50);
    draw();

</script>
</body>
</html>
