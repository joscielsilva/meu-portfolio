<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Plataforma Estável e Fluida</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #222;
            flex-direction: column;
            user-select: none;
            padding: 10px 0;
        }
        
        /* Container do Jogo (Onde a mágica acontece) */
        .game-container {
            position: relative;
            width: 800px;
            height: 400px;
            max-width: 95vw;
            max-height: 55vh; 
            outline: 4px solid #fff;
            box-shadow: 0px 0px 20px rgba(0,0,0,0.5);
        }

        canvas {
            background-color: #87CEEB; /* Cor do céu */
            display: block;
            width: 100%;
            height: 100%;
        }
        
        /* O score será exibido diretamente no HUD durante o jogo */
        .score-info { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            color: black; 
            font-weight: bold;
            z-index: 10;
        }

        /* --- CONTROLES MOBILE --- */
        .controls {
            display: none; 
            margin-top: 15px;
            width: 90%;
            max-width: 400px;
            justify-content: space-between;
            padding: 0 5px;
        }
        .controls-left { display: flex; gap: 10px; }
        button.d-pad {
            width: 60px;
            height: 60px;
            background-color: #444;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 0 #222;
        }
        button.d-pad:active { background-color: #3498db; transform: translateY(4px); box-shadow: none; }
        @media (max-width: 800px) { .controls { display: flex; } }
    </style>
</head>
<body>

<h1>Protótipo de Plataforma</h1>

<div class="game-container">
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    
    <div class="score-info">
        Score: <span id="currentScore">0</span><br>
        Recorde: <span id="highScoreDisplay">0</span>
    </div>

</div>

<div class="controls">
    <div class="controls-left">
        <button class="d-pad" id="btnLeft">⬅️</button>
        <button class="d-pad" id="btnRight">➡️</button>
    </div>
    <button class="d-pad" id="btnJump">⬆️</button>
</div>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const currentScoreDisplay = document.getElementById("currentScore");
    const highScoreDisplay = document.getElementById("highScoreDisplay");
    
    // --- 1. SISTEMA DE ÁUDIO ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        if (type === 'jump' || type === 'land') {
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(type === 'jump' ? 600 : 100, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.15);
        } else if (type === 'die') {
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.5);
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.5);
        }
    }

    // --- 2. CONFIGURAÇÕES E VARIÁVEIS ---
    const gravity = 0.6;
    const friction = 0.85; 
    
    let cameraX = 0;
    let score = 0;
    let isGameOver = false; // Começa como false para iniciar o jogo
    let lastTime = 0;

    const player = {
        x: 50,
        y: 0, 
        width: 30,
        height: 30,
        speed: 6,
        dx: 0, 
        dy: 0, 
        jumping: false, 
        color: "red"
    };

    let platforms = [];
    let enemies = [];
    let lastPlatformX = 0;
    let lastPlatformY = 350;

    let highScore = localStorage.getItem('platformHighScore') || 0;
    highScoreDisplay.innerText = highScore;

    const keys = { right: false, left: false, jump: false };

    // --- 3. INICIALIZAÇÃO (AGORA RODA SEM BOTÃO) ---
    function initGame() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        platforms = [];
        enemies = [];
        lastPlatformX = 0;
        lastPlatformY = 350;

        // Cria o chão inicial
        createPlatform(0, 350, 800, 50, false);
        
        // POSICIONAMENTO CRÍTICO (Estabilidade na plataforma)
        player.x = 50;
        player.y = platforms[0].y - player.height; 
        player.dx = 0;
        player.dy = 0;
        player.jumping = false; 
        
        cameraX = 0;
        score = 0;
        isGameOver = false;
        lastTime = 0; 
        currentScoreDisplay.innerText = score;

        // Limpa o loop anterior e inicia um novo
        requestAnimationFrame(gameLoop);
    }
    
    function gameOver() {
        isGameOver = true;
        playSound('die');

        // Exibir Game Over no HUD temporariamente
        currentScoreDisplay.innerText = "GAME OVER! Pontos: " + score;
        
        // Salva e exibe Recorde
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('platformHighScore', highScore);
            highScoreDisplay.innerText = highScore + " (NOVO!)";
        }

        // Aguarda 3 segundos e reinicia o jogo
        setTimeout(() => {
            initGame();
        }, 3000); 
    }

    // --- 4. GAME LOOP (Fluidez) ---
    function gameLoop(time) {
        if (isGameOver) return;
        
        requestAnimationFrame(gameLoop);

        const dt = time - lastTime;
        lastTime = time;

        const frameAdjust = dt / 16; 
        
        update(frameAdjust);
        draw();
    }


    // --- 5. LÓGICA DO JOGO (UPDATE) ---
    function update(frameAdjust) {
        
        // 5a. Aplicar Controles e Gravidade
        if (keys.right) player.dx = player.speed;
        if (keys.left) player.dx = -player.speed;
        
        let wasJumping = player.jumping; 

        if (keys.jump && !player.jumping) {
            player.jumping = true;
            player.dy = -12; 
            playSound('jump');
        }

        // Aplica Gravidade e Fricção
        player.dy += gravity * frameAdjust;
        player.dx *= friction; 

        // 5b. Atualizar Posição
        player.x += player.dx * frameAdjust;
        player.y += player.dy * frameAdjust;

        // 5c. Colisão com o Chão/Plataformas
        let onGround = false;

        for (let plat of platforms) {
            
            if (player.x < plat.x + plat.w &&
                player.x + player.width > plat.x &&
                player.y < plat.y + plat.h &&
                player.y + player.height > plat.y) {
                
                // Colisão por cima (Pouso)
                if (player.dy > 0 && player.y + player.height - player.dy <= plat.y) {
                    
                    if (wasJumping) playSound('land');
                    
                    player.jumping = false;
                    player.dy = 0;
                    // FIXO: Garante que a posição Y não afunde
                    player.y = plat.y - player.height; 
                    onGround = true;
                }
            }
        }
        
        // Se não estiver no chão (cair do buraco), volte a pular (para que a gravidade funcione)
        if (!onGround) {
            player.jumping = true; 
        }

        // 5d. Morte (Cair no buraco)
        if (player.y > canvas.height) {
            gameOver();
        }

        // 5e. Câmera e Geração de Mundo
        if (player.x > cameraX + 200) {
            cameraX = player.x - 200;
        }
        if (cameraX < 0) cameraX = 0;

        generateWorld();
    }
    
    // --- 6. GERAÇÃO DE MUNDO E UTILS ---

    function createPlatform(x, y, w, h, canSpawnEnemy) {
        platforms.push({ x, y, w, h });
    }

    function generateWorld() {
        while (lastPlatformX < cameraX + canvas.width + 200) {
            let gap = Math.floor(Math.random() * 90) + 50; 
            
            const maxUp = 100;
            const maxDown = 80;
            let minY = lastPlatformY - maxUp; 
            let maxY = lastPlatformY + maxDown;
            if (minY < 120) minY = 120;
            if (maxY > 360) maxY = 360;
            let newY = Math.floor(Math.random() * (maxY - minY + 1)) + minY;

            let newW = Math.floor(Math.random() * 200) + 100;

            createPlatform(lastPlatformX + gap, newY, newW, 40, score > 5);
            
            lastPlatformX += gap + newW;
            lastPlatformY = newY;
        }

        if (platforms.length > 0 && platforms[0].x + platforms[0].w < cameraX - 100) {
            platforms.shift();
            score++; 
            currentScoreDisplay.innerText = score;
        }
    }

    // --- 7. DESENHO ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(-cameraX, 0);

        // Plataformas
        ctx.fillStyle = "#654321";
        for (let plat of platforms) {
            ctx.fillRect(plat.x, plat.y, plat.w, plat.h);
            ctx.fillStyle = "#32CD32";
            ctx.fillRect(plat.x, plat.y, plat.w, 5);
            ctx.fillStyle = "#654321";
        }

        // Jogador
        ctx.fillStyle = player.color;
        ctx.fillRect(player.x, player.y, player.width, player.height);

        ctx.restore();
    }

    // --- 8. CONTROLES E LISTENERS ---
    document.addEventListener("keydown", (e) => {
        if (e.code === "ArrowRight") keys.right = true;
        if (e.code === "ArrowLeft") keys.left = true;
        if (e.code === "Space" || e.code === "ArrowUp") {
            keys.jump = true;
            e.preventDefault();
        }
    });

    document.addEventListener("keyup", (e) => {
        if (e.code === "ArrowRight") keys.right = false;
        if (e.code === "ArrowLeft") keys.left = false;
        if (e.code === "Space" || e.code === "ArrowUp") keys.jump = false;
    });

    // Controles Mobile
    document.getElementById("btnLeft").ontouchstart = (e) => { e.preventDefault(); keys.left = true; };
    document.getElementById("btnLeft").ontouchend = () => keys.left = false;
    
    document.getElementById("btnRight").ontouchstart = (e) => { e.preventDefault(); keys.right = true; };
    document.getElementById("btnRight").ontouchend = () => keys.right = false;

    document.getElementById("btnJump").ontouchstart = (e) => { e.preventDefault(); keys.jump = true; };
    document.getElementById("btnJump").ontouchend = () => keys.jump = false;
    
    // Inicia o Jogo Imediatamente
    initGame();
</script>
</body>
</html>
